<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="GraphStyling.css">
    <title>Weight Progress</title>
</head>
<body>
    <header>
        <p id="welcome">Welcome, <span id="userName"></span></p>
        <div class="profile-circle" id="profile-icon">
            <i class="fas fa-person profile-icon"></i>
        </div>
    </header>
    <div class="container-11">
        <a href="MainPage.html" class="back-arrow">&#8592; Back</a>
        <div class="chart-container">
            <canvas id="myChart"></canvas>
        </div>
        <div class="centered-container">
            <button class="input-button" id="toggle" onclick="toggleProgress()">Show Past Progress</button>
        </div>
        <div class="input-container">
            <label class="input-label" for="userCalorie">Recent Caloric Intake</label><br>
            <input type="number" id="userCalorie" class="input-box">
            <br>
            <label class="input-label" for="targetCalorie">Daily Target Intake:</label><br>
            <input type="number" id="targetCalorie" class="input-box">
            <br>
            <button class="input-button" onclick="addData()">Add Data</button>
        </div>
        <div class="centered-container">
            <button id="notificationButton" class="input-button" onclick="toggleNotifications()">Start Daily Reminders</button>
        </div>
    </div>
    <footer>
        <button class="tab-button" onclick="location.href = '../HomeScreen.html';">
            <i class="fas fa-home"></i>
        </button>
        <button class="tab-button" onclick="location.href = 'MainPage.html';">
            <i class="fas fa-bullseye"></i>
        </button>
        <button class="tab-button" onclick="location.href = '../WorkoutFunctionality/WorkoutPage.html';">
            <i class="fas fa-dumbbell"></i>
        </button>
        <button class="tab-button" onclick="location.href = '../nutritionDataBase.html';">
            <i class="fas fa-utensils"></i>
        </button>
        <button class="tab-button" onclick="location.href = '../BuddySystem.html';">
            <i class="fas fa-users"></i>
        </button>
    </footer>

    <script>
        const maxDataPoints = 7;
        const ctx = document.getElementById("myChart").getContext("2d");
        let chart = null; // Declare the chart variable
        let isPastProgressShown = false;

        // Check if it's the first load
        if (!localStorage.getItem("firstLoadDone931")) {
            const userCalorie = [2600, 2345, 1984, 2700];
            const targetCalorie = [2200, 2200, 2200, 2200];
            const dateLabels = ['11/3', '11/4', '11/5', '11/6'];
            localStorage.setItem("userCalorie", JSON.stringify(userCalorie));
            localStorage.setItem("targetCalorie", JSON.stringify(targetCalorie));
            localStorage.setItem("dateLabels", JSON.stringify(dateLabels));
            localStorage.setItem("firstLoadDone931", "true");
        }

        // Function to initialize or update the chart
        function initializeChart() {
            if (chart) {
                chart.destroy(); // Destroy the existing chart if it exists
            }
            const userCalorie = JSON.parse(localStorage.getItem("userCalorie"));
            const targetCalorie = JSON.parse(localStorage.getItem("targetCalorie"));
            const dateLabels = JSON.parse(localStorage.getItem("dateLabels"));

            chart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: dateLabels,
                    datasets: [
                        {
                            label: 'Caloric Intake',
                            data: userCalorie,
                            borderColor: "rgba(0, 0, 255, 1)",
                            borderWidth: 1,
                        },
                        {
                            label: 'Target Intake',
                            data: targetCalorie,
                            borderColor: "rgba(255, 0, 0, 1)",
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: false,
                        },
                    ],
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 4000,
                            ticks: {
                                fontSize: 24,
                            }
                        },
                        yAxes: [{
                            ticks: {
                                fontSize: 24,
                            }
                        }]
                    }
                }
            });
        }

        initializeChart(); // Initialize the chart

        let notificationIntervalId = null;
        const userCalorieHistory = [];
        const targetCalorieHistory = [];
        const dateLabelsHistory = [];
        let targetCalorie = 0;

        let currentProgress = "Recent Progress";
        let currentData = {
            userCalorie: [],
            targetCalorie: [],
            labels: [],
        };

        let remindersActive = false;

        // Function to toggle between "Recent Progress" and "Past Progress"
        function toggleProgress() {
            const button = document.getElementById("toggle");
            if (isPastProgressShown) {
                button.innerText = "Show Past Progress";
                showRecentProgress();
                currentProgress = "Recent Progress";
            } else {
                button.innerText = "Show Recent Progress";
                showAllData();
                currentProgress = "Past Progress";
            }
            isPastProgressShown = !isPastProgressShown;
        }

        function updateGraph(data1, data2, labels) {
            chart.data.datasets[0].data = data1;
            chart.data.datasets[1].data = data2;
            chart.data.labels = labels;
            chart.update();
        }

        function showRecentProgress() {
            updateGraph(currentData.userCalorie, currentData.targetCalorie, currentData.labels);
        }

        function showAllData() {
            updateGraph(userCalorieHistory, targetCalorieHistory, dateLabelsHistory);
        }

        function addData() {
            const userCalorie = document.getElementById("userCalorie").value;
            targetCalorie = document.getElementById("targetCalorie").value;
            if (userCalorie !== "") {
                const currentDate = new Date();
                const label = `${currentDate.getMonth() + 1}/${currentDate.getDate()}`;
                const labels = chart.data.labels;

                // Check if an entry for the current day already exists
                if (labels.includes(label)) {
                    // Update the existing entry
                    const index = labels.indexOf(label);
                    chart.data.datasets[0].data[index] = parseFloat(chart.data.datasets[0].data[index]) + parseFloat(userCalorie);
                } else {
                    if (chart.data.labels.length >= maxDataPoints) {
                        const removedUserCalorie = chart.data.datasets[0].data.shift();
                        const removedTargetCalorie = chart.data.datasets[1].data.shift();
                        const removedLabel = chart.data.labels.shift();
                        userCalorieHistory.push(removedUserCalorie);
                        targetCalorieHistory.push(removedTargetCalorie);
                        dateLabelsHistory.push(removedLabel);
                    }

                    chart.data.datasets[0].data.push(userCalorie);
                    chart.data.datasets[1].data.push(targetCalorie);
                    chart.data.labels.push(label);
                }

                // Update the chart
                chart.update();

                // Store the data for tracking
                currentData.userCalorie = chart.data.datasets[0].data.slice();
                currentData.targetCalorie = chart.data.datasets[1].data.slice();
                currentData.labels = chart.data.labels.slice();

                localStorage.setItem('userCalorie', JSON.stringify(chart.data.datasets[0].data));
                localStorage.setItem('targetCalorie', JSON.stringify(chart.data.datasets[1].data));
                localStorage.setItem('dateLabels', JSON.stringify(chart.data.labels));
                localStorage.setItem('userCalorieHistory', JSON.stringify(userCalorieHistory));
                localStorage.setItem('targetCalorieHistory', JSON.stringify(targetCalorieHistory));
                localStorage.setItem('dateLabelsHistory', JSON.stringify(dateLabelsHistory));

                document.getElementById("userCalorie").value = "";
                document.getElementById("userCalorie").focus();
            }
        }

        function toggleNotifications() {
            const notificationButton = document.getElementById("notificationButton");

            if (!remindersActive) {
                remindersActive = true;
                notificationButton.innerText = "Stop Reminders";
                notificationIntervalId = setInterval(sendNotifications, 10000); // Automatically send every 10 seconds
            } else {
                remindersActive = false;
                notificationButton.innerText = "Start Daily Reminders";
                clearInterval(notificationIntervalId);
            }
        }

        function sendNotifications() {
            alert("This is your reminder!");
        }
    </script>
</body>
</html>
